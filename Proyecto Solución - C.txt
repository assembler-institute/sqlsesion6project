NOTA: Todos los CREATE VIEW también pueden ser reemplazados por consultas anidadas

Consulta 1
--------------------------

CREATE VIEW suma_heridos_muertos AS
SELECT codigo_conflicto, SUM(num_heridos) + SUM(num_muertos) AS sum_her_muer
FROM historial_de_conflictos
GROUP BY codigo_conflicto;

CREATE VIEW total_organizaciones AS
SELECT COUNT(codigo_org) AS contar_organizaciones
FROM historial_intervenciones_mediadoras
WHERE codigo_org in (SELECT codigo
                     FROM organizaciones
                     WHERE codigo_orgdepen IS NULL)
GROUP BY codigo_conflicto;

INSERT INTO historial_intervenciones_armadas(codigo_gruparmado,codigo_conflicto,fecha_incorporacion)
SELECT (SELECT codigo_gruparmado
       FROM historial_intervenciones_armadas
       WHERE codigo_conflicto = (SELECT codigo_conflicto
                                 FROM historial_de_conflictos
                                 GROUP BY codigo_conflicto
                                 HAVING SUM(num_heridos) + SUM(num_muertos) = (SELECT MAX(sum_her_muer)
                                                                               FROM suma_heridos_muertos))
       AND fecha_incorporacion = (SELECT MIN(fecha_incorporacion)
                                  FROM historial_intervenciones_armadas
                                  WHERE codigo_conflicto = (SELECT codigo_conflicto
                                                            FROM historial_de_conflictos
                                                            GROUP BY codigo_conflicto
                                                            HAVING SUM(num_heridos) + SUM(num_muertos) = (SELECT MAX(sum_her_muer)
                                                                                                          FROM suma_heridos_muertos))
                                  GROUP BY codigo_conflicto)),
(SELECT codigo_conflicto
FROM historial_intervenciones_mediadoras
WHERE codigo_conflicto in (SELECT codigo 
                           FROM conflictos
                           WHERE causa = 'Religioso')
GROUP BY codigo_conflicto, codigo_org
HAVING COUNT(codigo_org) = (SELECT MAX(contar_organizaciones)
                            FROM total_organizaciones)
AND codigo_org in (SELECT codigo
                     FROM organizaciones
                     WHERE codigo_orgdepen IS NULL)),
current_date;



CONSULTA 2
-------------------------
UPDATE historial_de_conflictos SET num_heridos = num_heridos + 50, num_muertos = num_muertos + 12
WHERE codigo_pais = (SELECT codigo
                     FROM paises
                     WHERE capital = 'Kabul')
AND codigo_conflicto = (SELECT codigo_conflicto
                        FROM historial_intervenciones_armadas
                        WHERE codigo_gruparmado = (SELECT codigo
                                                   FROM grupos_armados
                                                   WHERE nombre = 'Ponchos Rojos'));


CONSULTA 3
-------------------------
SELECT p.nombre AS "Paises", SUM(num_heridos) AS "Nº de heridos", SUM(num_muertos) AS "Nº de muertos"
FROM historial_de_conflictos hc
LEFT JOIN paises p
ON hc.codigo_pais = p.codigo
GROUP BY p.codigo;


CONSULTA 4
-------------------------
SELECT nombre AS "Campos de refugiados"
FROM campos_refugiados
WHERE codigo in (SELECT e.codigo_refugio
                 FROM refugiados e
                 WHERE ((extract(year FROM current_date) - extract(year FROM e.fecha_llegada)) *12) + extract(MONTH FROM current_date) - extract(MONTH FROM e.fecha_llegada) <= 3
                 AND e.edad < '18'
                 GROUP BY e.codigo_refugio
                 HAVING COUNT(e.codigo_refugio) > (SELECT COUNT(codigo_refugio)
                                                   FROM refugiados
                                                   WHERE ((extract(year FROM current_date) - extract(year FROM fecha_llegada)) *12) + extract(MONTH FROM current_date) - extract(MONTH FROM fecha_llegada) <= 3
                                                   AND edad > '18'
                                                   AND codigo_refugio = e.codigo_refugio
                                                   GROUP BY codigo_refugio)
                 AND codigo_refugio in (SELECT codigo_refugio
                                        FROM paquetes
                                        WHERE nombre_producto = 'Leche'
                                        GROUP BY codigo_refugio
                                        HAVING sum(cantidad)/(SELECT COUNT(e.codigo)
                                                              FROM refugiados e
                                                              WHERE ((extract(year FROM current_date) - extract(year FROM e.fecha_llegada)) *12) + extract(MONTH FROM current_date) - extract(MONTH FROM e.fecha_llegada) <= 3
                                                              AND e.edad < '18'
                                                              GROUP BY e.codigo_refugio
                                                              HAVING COUNT(e.codigo_refugio) > (SELECT COUNT(codigo_refugio)
                                                                                                FROM refugiados
                                                                                                WHERE ((extract(year FROM current_date) - extract(year FROM fecha_llegada)) *12) + extract(MONTH FROM current_date) - extract(MONTH FROM fecha_llegada) <= 3
                                                                                                AND edad > '18'
                                                                                                AND codigo_refugio = e.codigo_refugio
                                                                                                GROUP BY codigo_refugio)) < 10));


CONSULTA 5
-------------------------
SELECT codigo AS "Codigo", nombre AS "Conflicto"
FROM conflictos
WHERE codigo in (SELECT codigo_conflicto
                 FROM historial_intervenciones_mediadoras
                 WHERE extract(YEAR FROM fecha_incorporacion) = '2013'
                 INTERSECT
                 SELECT codigo_conflicto
                 FROM historial_intervenciones_mediadoras
                 WHERE extract(YEAR FROM fecha_incorporacion) = '2014'
                 INTERSECT
                 SELECT codigo_conflicto
                 FROM historial_intervenciones_mediadoras
                 WHERE extract(YEAR FROM fecha_incorporacion) = '2015');


CONSULTA 6
-------------------------
SELECT cam.nombre AS "Nom. Campo de Refugiado", COUNT(codigo_envio) AS "Total de envios"
FROM campos_refugiados cam, paquetes paq
WHERE cam.codigo = paq.codigo_refugio
AND paq.codigo_envio in (SELECT env.codigo
                         FROM envios env, paquetes paq
                         WHERE env.codigo = paq.codigo_envio
                         AND ((extract(year FROM current_date) - extract(year FROM fecha_hora)) *12) + extract(MONTH FROM current_date) - extract(MONTH FROM fecha_hora) <= 6
                         AND UPPER(paq.nombre_producto) = 'LECHE EN POLVO')
GROUP BY cam.nombre;


CONSULTA 7
-------------------------
CREATE VIEW conflictos_activos AS 
SELECT MAX(DATEDIFF(current_date, fecha_incorporacion)) AS max_activo
FROM historial_intervenciones_armadas his, conflictos con
WHERE con.codigo = his.codigo_conflicto
AND his.fecha_retirada IS NULL
AND UPPER(con.causa) = 'RELIGIOSO'
GROUP BY codigo_conflicto;


SELECT nombre AS "Pais"
FROM paises
WHERE codigo in (SELECT codigo_pais
                FROM historial_de_conflictos
                WHERE codigo_conflicto in (SELECT codigo_conflicto
                                          FROM historial_intervenciones_armadas
                                          WHERE DATEDIFF(current_date, fecha_incorporacion) in (SELECT MAX(max_activo)
                                                                                                    FROM conflictos_activos)));


CONSULTA 8
-------------------------

CREATE VIEW producto_mayor AS 
SELECT codigo_envio, sum(cantidad) AS cuenta_producto
FROM paquetes
GROUP BY codigo_envio, nombre_producto;

SELECT codigo_envio AS "Codigo de envio", nombre_producto AS "Producto", sum(cantidad) AS "Cantidad total"
FROM paquetes
GROUP BY codigo_envio, nombre_producto
HAVING (codigo_envio, sum(cantidad)) in (SELECT codigo_envio, MAX(cuenta_producto)
                                         FROM producto_mayor
                                         GROUP BY codigo_envio)
AND codigo_envio in (SELECT codigo
                     FROM envios
                     WHERE codigo_org in (SELECT codigo
                                          FROM organizaciones
                                          WHERE codigo_orgdepen = 'ONU'));


CONSULTA 9
-------------------------
CREATE VIEW max_poblado AS
SELECT COUNT(codigo) AS total_refugiados
FROM refugiados
WHERE fecha_salida IS NULL
GROUP BY codigo_refugio;

SELECT codigo AS "Codigo", nombre AS "Oraganizaciones"
FROM organizaciones
WHERE codigo NOT IN (SELECT DISTINCT codigo_org
                     FROM envios env, paquetes paq
                     WHERE env.codigo = paq.codigo_envio
                     AND codigo_refugio = (SELECT codigo_refugio
                                               FROM refugiados
                                               WHERE fecha_salida IS NULL
                                               GROUP BY codigo_refugio
                                               HAVING COUNT(codigo) = (SELECT MAX(total_refugiados)
                                                                       FROM max_poblado)));


CONSULTA 10
-------------------------
CREATE VIEW maximas_fechas AS
SELECT MAX(fecha_retirada) AS max_fecha 
FROM historial_intervenciones_armadas
GROUP BY codigo_conflicto;

CREATE VIEW gruparmados_retirados AS
SELECT gru.nombre AS "Grupo armado", his.fecha_retirada AS "Ultima fecha retirada"
FROM historial_intervenciones_armadas his, grupos_armados gru
WHERE his.codigo_gruparmado = gru.codigo
AND fecha_retirada IS NOT NULL
AND codigo_gruparmado NOT IN (SELECT codigo_gruparmado
                              FROM historial_intervenciones_armadas
                              WHERE fecha_retirada IS NULL)
AND fecha_retirada in (SELECT MAX(max_fecha)
                       FROM maximas_fechas)
GROUP BY gru.nombre, fecha_retirada;